<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <title>ì—°ìš°ì˜ ë°œìêµ­ - ì»¬ëŸ¬ ëŒ€ì‹œë³´ë“œ</title>
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/flatpickr/dist/flatpickr.min.css">
    <style>
        :root { --main-blue: #2563eb; --bg-gray: #f8fafc; }
        body { margin: 0; display: flex; flex-direction: column; height: 100vh; font-family: 'Arial', sans-serif; background: var(--bg-gray); overflow: hidden; }
        header { height: 60px; background: white; display: flex; align-items: center; padding: 0 20px; border-bottom: 1px solid #e2e8f0; justify-content: space-between; z-index: 2000; }
        .logo { font-weight: bold; color: var(--main-blue); font-size: 1.2rem; cursor: pointer; }
        .main-container { display: flex; flex: 1; overflow: hidden; }
        .sidebar { width: 350px; background: white; border-right: 1px solid #e2e8f0; overflow-y: auto; padding: 20px; z-index: 1500; }
        .card { border-left: 5px solid var(--main-blue); background: #fff; border-radius: 8px; padding: 15px; margin-bottom: 15px; box-shadow: 0 2px 4px rgba(0,0,0,0.05); cursor: pointer; transition: 0.2s; }
        .card:hover { transform: translateY(-2px); }
        .btn-add { width: 100%; background: var(--main-blue); color: white; border: none; padding: 12px; border-radius: 8px; cursor: pointer; font-weight: bold; margin-bottom: 20px; }
        #map { flex: 1; z-index: 1000; }
        #inputModal { display: none; position: fixed; top: 50%; left: 50%; transform: translate(-50%, -50%); background: white; padding: 25px; border-radius: 15px; z-index: 3000; box-shadow: 0 20px 25px rgba(0,0,0,0.2); width: 340px; }
        .overlay { display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.5); z-index: 2500; }
        select, input { width: 100%; padding: 10px; margin: 8px 0; border: 1px solid #ddd; border-radius: 6px; box-sizing: border-box; }
        .option-group { display: flex; align-items: center; gap: 10px; margin: 5px 0; font-size: 0.85rem; }
    </style>
</head>
<body>

<header>
    <div class="logo" onclick="location.href='index.html'">ğŸ‘£ footprint</div>
    <div style="font-size: 0.9rem; color: #64748b;">ì—°ìš°ë‹˜ì˜ ì»¬ëŸ¬ ì—¬í–‰ ì§€ë„</div>
</header>

<div class="main-container">
    <aside class="sidebar">
        <button class="btn-add" onclick="openModal()">+ ìƒˆë¡œìš´ ë°œìêµ­ ë‚¨ê¸°ê¸°</button>
        <div id="record-list">ë°ì´í„°ë¥¼ ë¶ˆëŸ¬ì˜¤ëŠ” ì¤‘...</div>
    </aside>
    <div id="map"></div>
</div>

<div class="overlay" id="overlay" onclick="closeModal()"></div>
<div id="inputModal">
    <h3>ì–´ë””ë¥¼ ìƒ‰ì¹ í• ê¹Œìš”?</h3>
    <select id="country-select" onchange="updateCityOptions()">
        <option value="">êµ­ê°€ ì„ íƒ</option>
        <optgroup label="ì£¼ìš” êµ­ê°€">
            <option value="South Korea">ëŒ€í•œë¯¼êµ­ ğŸ‡°ğŸ‡·</option>
            <option value="Japan">ì¼ë³¸ ğŸ‡¯ğŸ‡µ</option>
            <option value="China">ì¤‘êµ­ ğŸ‡¨ğŸ‡³</option>
            <option value="Philippines">í•„ë¦¬í•€ ğŸ‡µğŸ‡­</option>
        </optgroup>
    </select>
    <select id="city-select">
        <option value="">ë„ì‹œ ì„ íƒ</option>
    </select>
    <input type="text" id="date-range" placeholder="ì—¬í–‰ ê¸°ê°„ ì„ íƒ">
    
    <div class="option-group">
        <span>ì¹ í•  ìƒ‰ìƒ:</span>
        <input type="color" id="color-choice" value="#2563eb" style="width:50px; height:30px; cursor:pointer;">
    </div>
    <div class="option-group">
        <span>íŒ¨í„´:</span>
        <select id="pattern-select" style="margin:0; padding:5px;">
            <option value="solid">ë‹¨ìƒ‰ (Solid)</option>
            <option value="stripe">ë¹—ê¸ˆ (Stripe)</option>
            <option value="dot">ì ë¬´ëŠ¬ (Dot)</option>
        </select>
    </div>

    <button onclick="addRecord()" style="width:100%; background:var(--main-blue); color:white; border:none; padding:12px; border-radius:8px; font-weight:bold; margin-top:15px; cursor:pointer;">ê¸°ë¡ ë° ìƒ‰ì¹ í•˜ê¸°</button>
</div>

<script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
<script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
<script src="https://cdn.jsdelivr.net/npm/flatpickr"></script>

<script>
    const SUPABASE_URL = 'https://uywqxhinsowmlfysmbxi.supabase.co';
    const SUPABASE_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InV5d3F4aGluc293bWxmeXNtYnhpIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NzAxMTc3NjUsImV4cCI6MjA4NTY5Mzc2NX0.ez3CXzjh-nuS8cL1vv7NXX7UKlP03DLcEi5H0iNoSJY';
    const _supabase = supabase.createClient(SUPABASE_URL, SUPABASE_KEY);

    var map = L.map('map').setView([20, 120], 3);
    L.tileLayer('https://{s}.basemaps.cartocdn.com/light_all/{z}/{x}/{y}{r}.png').addTo(map);
    
    var markers = [];
    var coloredLayers = [];

    // ì—°ìš°ë‹˜ì„ ìœ„í•œ ì‚¬ì „ ì •ì˜ ë°ì´í„°
    const travelData = {
        "South Korea": { "ì œì£¼": [33.4996, 126.5312], "ì„œìš¸": [37.5665, 126.9780], "ì¸ì²œ": [37.4563, 126.7052] },
        "Japan": { "ë§ˆì“°ì•¼ë§ˆ": [33.8392, 132.7654], "ì‹œì¦ˆì˜¤ì¹´": [34.9751, 138.3831], "ë„ì¿„": [35.6895, 139.6917] },
        "China": { "ì¹­ë‹¤ì˜¤": [36.0671, 120.3826], "ë² ì´ì§•": [39.9042, 116.4074] },
        "Philippines": { "ë§ˆë‹ë¼": [14.5995, 120.9842], "ì„¸ë¶€": [10.3157, 123.8854] }
    };

    function updateCityOptions() {
        const country = document.getElementById('country-select').value;
        const citySelect = document.getElementById('city-select');
        citySelect.innerHTML = '<option value="">ë„ì‹œ ì„ íƒ</option>';
        if(country && travelData[country]) {
            Object.keys(travelData[country]).forEach(city => {
                citySelect.innerHTML += `<option value="${city}">${city}</option>`;
            });
        }
    }

    flatpickr("#date-range", { mode: "range", dateFormat: "Y-m-d" });

    async function addRecord() {
        const country = document.getElementById('country-select').value;
        const city = document.getElementById('city-select').value;
        const date = document.getElementById('date-range').value;
        const color = document.getElementById('color-choice').value;
        const pattern = document.getElementById('pattern-select').value;

        if(!country || !city || !date) return alert('ëª¨ë“  ì •ë³´ë¥¼ ì„ íƒí•´ ì£¼ì„¸ìš”!');

        const coords = travelData[country][city];

        const { error } = await _supabase.from('records').insert([{ 
            country, city, travel_date: date, lat: coords[0], lon: coords[1], color, pattern 
        }]);

        if(!error) {
            alert('ì„±ê³µì ìœ¼ë¡œ ê¸°ë¡ë˜ì—ˆìŠµë‹ˆë‹¤!');
            closeModal();
            loadRecords();
            focusLocation(coords[0], coords[1]);
        }
    }

    async function loadRecords() {
        const { data } = await _supabase.from('records').select('*').order('travel_date', { ascending: false });
        const list = document.getElementById('record-list');
        list.innerHTML = '';
        
        markers.forEach(m => map.removeLayer(m));
        coloredLayers.forEach(l => map.removeLayer(l));
        markers = []; coloredLayers = [];

        if(data) {
            data.forEach(r => {
                // 1. ì˜ì—­ ìƒ‰ì¹  (GeoJSON ëŒ€ìš© Circle - íŒ¨í„´ ì‹œê°í™”)
                const area = L.circle([r.lat, r.lon], {
                    color: r.color,
                    fillColor: r.color,
                    fillOpacity: r.pattern === 'stripe' ? 0.2 : 0.5, // íŒ¨í„´ì— ë”°ë¼ íˆ¬ëª…ë„ ì¡°ì ˆë¡œ ëŠë‚Œ ì°¨ì´
                    dashArray: r.pattern === 'stripe' ? '5, 10' : null, // ë¹—ê¸ˆ ëŒ€ì‹  ì ì„  íš¨ê³¼
                    radius: 35000 
                }).addTo(map);
                coloredLayers.push(area);

                // 2. ë§ˆì»¤
                const marker = L.marker([r.lat, r.lon]).addTo(map).bindPopup(`<b>${r.city}</b>`);
                markers.push(marker);

                // 3. ì¹´ë“œ
                list.innerHTML += `
                    <div class="card" style="border-left-color:${r.color}" onclick="focusLocation(${r.lat}, ${r.lon})">
                        <h4 style="margin:0;">${r.city} (${r.pattern})</h4>
                        <p style="margin:5px 0 0 0; font-size:0.8rem; color:#64748b;">${r.travel_date}</p>
                    </div>`;
            });
        }
    }

    function focusLocation(lat, lon) {
        map.flyTo([lat, lon], 9, { animate: true, duration: 1.5 });
    }

    function openModal() { document.getElementById('inputModal').style.display='block'; document.getElementById('overlay').style.display='block'; }
    function closeModal() { document.getElementById('inputModal').style.display='none'; document.getElementById('overlay').style.display='none'; }
    
    loadRecords();
</script>
</body>
</html>
